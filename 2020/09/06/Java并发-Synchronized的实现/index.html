<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"skywaterliu.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.11.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":true,"nav":{"utterances":{"order":-1}},"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Monitor基础 为什么要学习Monitor 在JDK1.6之前，Synchronized为重量级锁，其实现只依赖于Monitor，效率较低。学习Monitor，是为学习Synchronized打下基础。  什么是Monitor Monitor是一种同步机制。它并不单单属于Java，而是一种系统级别的设计理念。  开发并发应用时，经常需要设计这样的对象，该对象的方法会在多线程的环境下被调用，而这">
<meta property="og:type" content="article">
<meta property="og:title" content="Java并发-Synchronized的实现">
<meta property="og:url" content="https://skywaterliu.github.io/2020/09/06/Java%E5%B9%B6%E5%8F%91-Synchronized%E7%9A%84%E5%AE%9E%E7%8E%B0/index.html">
<meta property="og:site_name" content="安之一隅">
<meta property="og:description" content="Monitor基础 为什么要学习Monitor 在JDK1.6之前，Synchronized为重量级锁，其实现只依赖于Monitor，效率较低。学习Monitor，是为学习Synchronized打下基础。  什么是Monitor Monitor是一种同步机制。它并不单单属于Java，而是一种系统级别的设计理念。  开发并发应用时，经常需要设计这样的对象，该对象的方法会在多线程的环境下被调用，而这">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/Tlx9eKQ5zJw1FDL.jpg">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/qIP3clDpdS1jToK.jpg">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/e6RK9MfqbA2BLpy.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/XOl6P29qpFWHKrY.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/aL2FyzqT7Dh5NlQ.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/JmFQd8HaOR9uCSN.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/dixMak4HhE1Fl3e.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/E18VDtjs6hUbHg3.jpg">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/CRFvQy9LVbu6UYh.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/w17ZxmlzrBIOHuq.jpg">
<meta property="article:published_time" content="2020-09-06T09:38:00.000Z">
<meta property="article:modified_time" content="2022-04-16T13:04:41.216Z">
<meta property="article:author" content="你丶一顾倾城">
<meta property="article:tag" content="多线程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/04/16/Tlx9eKQ5zJw1FDL.jpg">


<link rel="canonical" href="https://skywaterliu.github.io/2020/09/06/Java%E5%B9%B6%E5%8F%91-Synchronized%E7%9A%84%E5%AE%9E%E7%8E%B0/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://skywaterliu.github.io/2020/09/06/Java%E5%B9%B6%E5%8F%91-Synchronized%E7%9A%84%E5%AE%9E%E7%8E%B0/","path":"2020/09/06/Java并发-Synchronized的实现/","title":"Java并发-Synchronized的实现"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Java并发-Synchronized的实现 | 安之一隅</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">安之一隅</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">莫听穿林打叶声，何妨吟啸且徐行。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Monitor%E5%9F%BA%E7%A1%80"><span class="nav-number">1.</span> <span class="nav-text">Monitor基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%AD%A6%E4%B9%A0Monitor"><span class="nav-number">1.1.</span> <span class="nav-text">为什么要学习Monitor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFMonitor"><span class="nav-number">1.2.</span> <span class="nav-text">什么是Monitor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Monitor%E7%BB%93%E6%9E%84"><span class="nav-number">1.3.</span> <span class="nav-text">Monitor结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Monitor%E5%BA%8F%E5%88%97%E5%9B%BE"><span class="nav-number">1.4.</span> <span class="nav-text">Monitor序列图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Java-Monitor-Object"><span class="nav-number">1.5.</span> <span class="nav-text">Java Monitor Object</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Synchronized%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="nav-number">2.</span> <span class="nav-text">Synchronized实现原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%A4%B4"><span class="nav-number">2.1.</span> <span class="nav-text">对象头</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mark-Word"><span class="nav-number">2.2.</span> <span class="nav-text">Mark Word</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lock-Record"><span class="nav-number">2.3.</span> <span class="nav-text">Lock Record</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%94%81%E7%B1%BB%E5%9E%8B%E4%B8%8E%E9%94%81%E7%9A%84%E5%8D%87%E7%BA%A7"><span class="nav-number">2.4.</span> <span class="nav-text">锁类型与锁的升级</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%81%8F%E5%90%91%E9%94%81"><span class="nav-number">2.4.1.</span> <span class="nav-text">偏向锁</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%B3%E9%97%AD%E5%81%8F%E5%90%91%E9%94%81"><span class="nav-number">2.4.1.1.</span> <span class="nav-text">关闭偏向锁</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81"><span class="nav-number">2.4.2.</span> <span class="nav-text">轻量级锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%87%8D%E9%87%8F%E7%BA%A7%E9%94%81"><span class="nav-number">2.4.3.</span> <span class="nav-text">重量级锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%89%E7%A7%8D%E9%94%81%E7%9A%84%E5%AF%B9%E6%AF%94"><span class="nav-number">2.4.4.</span> <span class="nav-text">三种锁的对比</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">你丶一顾倾城</p>
  <div class="site-description" itemprop="description">嗨害嗨！</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">26</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/skywaterliu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;skywaterliu" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:liutianshui17@gmail.com" title="E-Mail → mailto:liutianshui17@gmail.com" rel="noopener" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://skywaterliu.github.io/2020/09/06/Java%E5%B9%B6%E5%8F%91-Synchronized%E7%9A%84%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="你丶一顾倾城">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安之一隅">
      <meta itemprop="description" content="嗨害嗨！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Java并发-Synchronized的实现 | 安之一隅">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Java并发-Synchronized的实现
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-06 17:38:00" itemprop="dateCreated datePublished" datetime="2020-09-06T17:38:00+08:00">2020-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-16 21:04:41" itemprop="dateModified" datetime="2022-04-16T21:04:41+08:00">2022-04-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%90%8E%E7%AB%AF/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <!-- toc -->

<span id="more"></span>

<h2 id="Monitor基础"><a href="#Monitor基础" class="headerlink" title="Monitor基础"></a>Monitor基础</h2><h3 id="为什么要学习Monitor"><a href="#为什么要学习Monitor" class="headerlink" title="为什么要学习Monitor"></a>为什么要学习Monitor</h3><p>在JDK1.6之前，Synchronized为重量级锁，其实现只依赖于Monitor，效率较低。学习Monitor，是为学习Synchronized打下基础。</p>
<h3 id="什么是Monitor"><a href="#什么是Monitor" class="headerlink" title="什么是Monitor"></a>什么是Monitor</h3><p>Monitor是一种同步机制。它并不单单属于Java，而是一种系统级别的设计理念。</p>
<p>开发并发应用时，经常需要设计这样的对象，该对象的方法会在多线程的环境下被调用，而这些方法的执行都会改变该对象本身的状态。为了防止竞争条件 (race condition) 的出现，对于这类对象的设计，需要考虑解决以下问题：</p>
<ul>
<li><p>在任一时间内，只有唯一的公共的成员方法，被唯一的线程所执行。</p>
</li>
<li><p>对于对象的调用者来说，如果总是需要在调用方法之前进行拿锁，而在调用方法之后进行放锁，这将会使并发应用编程变得更加困难。合理的设计是，该对象本身确保任何针对它的方法请求的同步被透明的进行，而不需要调用者的介入。</p>
</li>
<li><p>如果一个对象的方法执行过程中，由于某些条件不能满足而阻塞，应该允许其它的客户端线程的方法调用可以访问该对象。</p>
</li>
</ul>
<p>Monitor Object 设计模式就是为了解决这类问题：</p>
<p>将被客户线程并发访问的对象定义为一个 monitor 对象。客户线程仅仅通过 monitor 对象的同步方法才能使用 monitor 对象定义的服务。为了防止陷入竞争条件，在任一时刻只能有一个同步方法被执行。</p>
<p>每一个 monitor 对象包含一个 monitor 锁，被同步方法用于串行访问对象的行为和状态。此外，同步方法可以根据一个或多个与 monitor 对象相关的 monitor conditions 来决定在何种情况下挂起或恢复他们的执行。</p>
<h3 id="Monitor结构"><a href="#Monitor结构" class="headerlink" title="Monitor结构"></a>Monitor结构</h3><p>Monitor机制中，共有四种角色：</p>
<ul>
<li><p><strong>监视者对象 Monitor Object</strong></p>
<p>负责公共的接口方法，这些公共的接口方法会在多线程的环境下被调用执行。</p>
</li>
<li><p><strong>同步方法：</strong></p>
<p>这些方法是监视者对象所定义。为了防止竞争条件，无论是否同时有多个线程并发调用同步方法，还是监视者对象含有多个同步方法，在任一时间内只有监视者对象的一个同步方法能够被执行。</p>
</li>
<li><p><strong>监视锁 (Monitor Lock):</strong> </p>
<p>每一个监视者对象都会拥有一把监视锁。</p>
</li>
<li><p><strong>监视条件 (Monitor Condition):</strong> </p>
<p>同步方法使用监视锁和监视条件来决定方法是否需要阻塞或重新执行。如果拥有监视锁，则可以调用方法，而当满足某个监视条件，则会记录工作进度，交还监视锁。一直在监视条件上挂起（<strong>WAITING &#x2F; TIMED_WAITING</strong>）。</p>
</li>
</ul>
<h3 id="Monitor序列图"><a href="#Monitor序列图" class="headerlink" title="Monitor序列图"></a>Monitor序列图</h3><p>在监视者对象模式中，在参与者之间将发生如下的协作过程：</p>
<ol>
<li><p><strong>同步方法的调用和串行化</strong></p>
<p>当客户线程调用监视者对象的同步方法时，必须首先获取它的监视锁。只要该监视者对象有其他同步方法正在被执行，获取操作便不会成功。在这种情况下，客户线程将被阻塞直到它获取监视锁。当客户线程成功获取监视锁后，进入临界区，执行方法实现的服务。一旦同步方法完成执行，监视锁会被自动释放，目的是使其他客户线程有机会调用执行该监视者对象的同步方法。</p>
</li>
<li><p><strong>同步方法线程挂起</strong></p>
<p>如果调用同步方法的客户线程必须被阻塞或是有其他原因不能立刻进行，它能够在一个监视条件上等待，这将导致该客户线程暂时释放监视锁，并被挂起在监视条件上。</p>
</li>
<li><p><strong>监视条件通知</strong></p>
<p>一个客户线程能够通知一个监视条件，目的是为了让一个前期使自己挂起在一个监视条件上的同步方法线程恢复运行。</p>
</li>
<li><p><strong>同步方法线程恢复</strong></p>
<p>一旦一个早先被挂起在监视条件上的同步方法线程获取通知，它将继续在最初的等待监视条件的点上执行。在被通知线程被允许恢复执行同步方法之前，监视锁将自动被获取。图 1 描述了<code>监视者</code>对象的动态特性。</p>
<p><strong>图 1. Monitor Object Sequence Diagram.</strong></p>
</li>
</ol>
<p><img src="https://s2.loli.net/2022/04/16/Tlx9eKQ5zJw1FDL.jpg" alt="图 1. Monitor Object Sequence Diagram"></p>
<h3 id="Java-Monitor-Object"><a href="#Java-Monitor-Object" class="headerlink" title="Java Monitor Object"></a>Java Monitor Object</h3><p>Java Monitor 从两个方面来支持线程之间的同步，即：互斥执行与协作。</p>
<ul>
<li><p><strong>互斥执行</strong></p>
<p> 对象内(对应到锁对象代码块内)的所有方法都<strong>互斥</strong>的执行。好比一个 Monitor 只有一个运行许可，任一个线程进入任何一个方法都需要获得这个许可，离开时把许可归还。</p>
</li>
<li><p><strong>协作</strong></p>
<p> 通常提供signal（等待&#x2F;通知）机制：允许正持有许可的线程暂时放弃许可，等待某个监视条件成真，条件成立后，当前线程可以通知正在等待这个条件的线程，让它可以重新获得运行许可。</p>
</li>
</ul>
<ol>
<li>线程进入同步方法中：</li>
<li>为了继续执行临界区代码，线程必须获取 Monitor 锁。如果获取锁成功，将成为该监视者对象的拥有者。任一时刻内，监视者对象只属于一个活动线程（The Owner）</li>
<li>拥有监视者对象的线程可以调用 wait() 进入等待集合（Wait Set），同时释放监视锁，进入等待状态。</li>
<li>其他线程调用 notify() &#x2F; notifyAll() 接口唤醒等待集合中的线程，这些等待的线程需要<strong>重新获取监视锁后</strong>才能执行 wait() 之后的代码。</li>
<li>同步方法执行完毕了，线程退出临界区，并释放监视锁。</li>
</ol>
<p>实质上，Java 的 Object 类本身就是监视者对象，Java 语言对于这样一个典型并发设计模式做了内建的支持。</p>
<p> Java 使用对象锁 ( 使用 synchronized 获得对象锁 ) 保证工作在共享的数据集上的线程<strong>互斥</strong>执行 , 使用 notify&#x2F;notifyAll&#x2F;wait 方法来<strong>协同</strong>不同线程之间的工作。这些方法在 Object 类上被定义，会被所有的 Java 对象自动继承。</p>
<p>在Java虚拟机(HotSpot)中，monitor是由ObjectMonitor实现的，其主要数据结构如下（位于HotSpot虚拟机源码ObjectMonitor.hpp文件，C++实现的）。</p>
<p><strong>图 2. Java Monitor</strong></p>
<p><img src="https://s2.loli.net/2022/04/16/qIP3clDpdS1jToK.jpg" alt="图 2. Java Monitor"></p>
<p>ObjectMonitor中有两个队列，_WaitSet和_EntryList，用来保存ObjectWaiter对象列表(每个等待锁的线程都会被封装成ObjectWaiter对象。</p>
<p>_owner指向持有ObjectMonitor对象的线程，当多个线程同时访问一段同步代码时，首先会进入 _EntryList 集合，当线程获取到对象的monitor 后进入 _Owner 区域并把monitor中的owner变量设置为当前线程同时monitor中的计数器count加1，若线程调用wait()方法，将释放当前持有的monitor，owner变量恢复为null，count自减1，同时该线程进入WaitSet集合中等待被唤醒。若当前线程执行完毕也将释放monitor(锁)并复位变量的值，以便其他线程进入获取monitor(锁)。</p>
<h2 id="Synchronized实现原理"><a href="#Synchronized实现原理" class="headerlink" title="Synchronized实现原理"></a>Synchronized实现原理</h2><p>Synchonized可用于普通同步方法、静态同步方法，以及局部代码块。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 普通方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Object <span class="title function_">parse</span><span class="params">(String str)</span>&#123;...&#125;</span><br><span class="line"><span class="comment">// 同步方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Object <span class="title function_">parse</span><span class="params">(String str)</span>&#123;...&#125;</span><br><span class="line"><span class="comment">// 局部代码块</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">parse</span><span class="params">(String str)</span>&#123;</span><br><span class="line">    synchonized(lock)&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>普通同步方法</p>
<p>当加在普通方法时，使用的锁为当前实例对象，及this对象</p>
</li>
<li><p>静态同步方法</p>
<p>当加在静态同步方法，锁是当前类的Class对象</p>
</li>
<li><p>局部代码块</p>
<p>当在局部代码块使用<code>synchronized</code>关键字时，使用的锁是括号中的对象</p>
</li>
</ul>
<p>当我们使用<code>synchronized</code>修饰方法名时，编译后会在方法名上生成一个ACC_SYNCHRONIZED标识来实现同步。</p>
<p>代码块同步使用<code>monitorenter</code>与<code>monitorexit</code>指令字节码来实现。每个<code>monitorenter</code>必有与之对应的<code>monitorexit</code>。<code>monitorenter</code>会再编译后插入到同步代码块的开始位置，<code>monitorexit</code>会插入到同步代码块结束以及异常的位置。当线程执行到<code>monitorenter</code>时，会申请该代码块的锁。</p>
<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestSync</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">MyLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyLock</span>();</span><br><span class="line">        <span class="keyword">synchronized</span>(lock)&#123;</span><br><span class="line">            lock.output();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyLock</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">output</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译后javap -v TestSync.class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\skywater\Desktop&gt; javap -v .\TestSync.<span class="keyword">class</span></span><br><span class="line"><span class="title class_">Classfile</span> /C:/Users/skywater/Desktop/TestSync.<span class="keyword">class</span></span><br><span class="line">  <span class="title class_">Last</span> modified <span class="number">2020</span>-<span class="number">9</span>-<span class="number">6</span>; size <span class="number">457</span> bytes</span><br><span class="line">  MD5 checksum 736aaa775042ba09d031d3781250f216</span><br><span class="line">  Compiled from <span class="string">&quot;TestSync.java&quot;</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestSync</span></span><br><span class="line">  minor version: <span class="number">0</span></span><br><span class="line">  major version: <span class="number">52</span></span><br><span class="line">  flags: ACC_PUBLIC, ACC_SUPER</span><br><span class="line">Constant pool:</span><br><span class="line">   #<span class="number">1</span> = Methodref          #<span class="number">6.</span>#<span class="number">20</span>         <span class="comment">// java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">   #<span class="number">2</span> = Class              #<span class="number">21</span>            <span class="comment">// MyLock</span></span><br><span class="line">   #<span class="number">3</span> = Methodref          #<span class="number">2.</span>#<span class="number">20</span>         <span class="comment">// MyLock.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">   #<span class="number">4</span> = Methodref          #<span class="number">2.</span>#<span class="number">22</span>         <span class="comment">// MyLock.output:()V</span></span><br><span class="line">   #<span class="number">5</span> = Class              #<span class="number">23</span>            <span class="comment">// TestSync</span></span><br><span class="line">   #<span class="number">6</span> = Class              #<span class="number">24</span>            <span class="comment">// java/lang/Object</span></span><br><span class="line">   #<span class="number">7</span> = Utf8               &lt;init&gt;</span><br><span class="line">   #<span class="number">8</span> = Utf8               ()V</span><br><span class="line">   #<span class="number">9</span> = Utf8               Code</span><br><span class="line">  #<span class="number">10</span> = Utf8               LineNumberTable</span><br><span class="line">  #<span class="number">11</span> = Utf8               main</span><br><span class="line">  #<span class="number">12</span> = Utf8               ([Ljava/lang/String;)V</span><br><span class="line">  #<span class="number">13</span> = Utf8               StackMapTable</span><br><span class="line">  #<span class="number">14</span> = Class              #<span class="number">25</span>            <span class="comment">// &quot;[Ljava/lang/String;&quot;</span></span><br><span class="line">  #<span class="number">15</span> = Class              #<span class="number">21</span>            <span class="comment">// MyLock</span></span><br><span class="line">  #<span class="number">16</span> = Class              #<span class="number">24</span>            <span class="comment">// java/lang/Object</span></span><br><span class="line">  #<span class="number">17</span> = Class              #<span class="number">26</span>            <span class="comment">// java/lang/Throwable</span></span><br><span class="line">  #<span class="number">18</span> = Utf8               SourceFile</span><br><span class="line">  #<span class="number">19</span> = Utf8               TestSync.java</span><br><span class="line">  #<span class="number">20</span> = NameAndType        #<span class="number">7</span>:#<span class="number">8</span>          <span class="comment">// &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">  #<span class="number">21</span> = Utf8               MyLock</span><br><span class="line">  #<span class="number">22</span> = NameAndType        #<span class="number">27</span>:#<span class="number">8</span>         <span class="comment">// output:()V</span></span><br><span class="line">  #<span class="number">23</span> = Utf8               TestSync</span><br><span class="line">  #<span class="number">24</span> = Utf8               java/lang/Object</span><br><span class="line">  #<span class="number">25</span> = Utf8               [Ljava/lang/String;</span><br><span class="line">  #<span class="number">26</span> = Utf8               java/lang/Throwable</span><br><span class="line">  #<span class="number">27</span> = Utf8               output</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">TestSync</span><span class="params">()</span>;</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: aload_0</span><br><span class="line">         <span class="number">1</span>: invokespecial #<span class="number">1</span>                  <span class="comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">         <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">1</span>: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(java.lang.String[])</span>;</span><br><span class="line">    descriptor: ([Ljava/lang/String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">2</span>, locals=<span class="number">4</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: <span class="keyword">new</span>           #<span class="number">2</span>                  <span class="comment">// class MyLock</span></span><br><span class="line">         <span class="number">3</span>: dup</span><br><span class="line">         <span class="number">4</span>: invokespecial #<span class="number">3</span>                  <span class="comment">// Method MyLock.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">         <span class="number">7</span>: astore_1</span><br><span class="line">         <span class="number">8</span>: aload_1</span><br><span class="line">         <span class="number">9</span>: dup</span><br><span class="line">        <span class="number">10</span>: astore_2</span><br><span class="line">        <span class="number">11</span>: monitorenter</span><br><span class="line">        <span class="number">12</span>: aload_1</span><br><span class="line">        <span class="number">13</span>: invokevirtual #<span class="number">4</span>                  <span class="comment">// Method MyLock.output:()V</span></span><br><span class="line">        <span class="number">16</span>: aload_2</span><br><span class="line">        <span class="number">17</span>: monitorexit</span><br><span class="line">        <span class="number">18</span>: goto          <span class="number">26</span></span><br><span class="line">        <span class="number">21</span>: astore_3</span><br><span class="line">        <span class="number">22</span>: aload_2</span><br><span class="line">        <span class="number">23</span>: monitorexit</span><br><span class="line">        <span class="number">24</span>: aload_3</span><br><span class="line">        <span class="number">25</span>: athrow</span><br><span class="line">        <span class="number">26</span>: <span class="keyword">return</span></span><br><span class="line">      Exception table:</span><br><span class="line">         from    to  target type</span><br><span class="line">            <span class="number">12</span>    <span class="number">18</span>    <span class="number">21</span>   any</span><br><span class="line">            <span class="number">21</span>    <span class="number">24</span>    <span class="number">21</span>   any</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">4</span>: <span class="number">0</span></span><br><span class="line">        line <span class="number">5</span>: <span class="number">8</span></span><br><span class="line">        line <span class="number">6</span>: <span class="number">12</span></span><br><span class="line">        line <span class="number">7</span>: <span class="number">16</span></span><br><span class="line">        line <span class="number">8</span>: <span class="number">26</span></span><br><span class="line">      StackMapTable: number_of_entries = <span class="number">2</span></span><br><span class="line">        frame_type = <span class="number">255</span> <span class="comment">/* full_frame */</span></span><br><span class="line">          offset_delta = <span class="number">21</span></span><br><span class="line">          locals = [ class <span class="string">&quot;[Ljava/lang/String;&quot;</span>, <span class="keyword">class</span> <span class="title class_">MyLock</span>, <span class="keyword">class</span> <span class="title class_">java</span>/lang/Object ]</span><br><span class="line">          stack = [ <span class="keyword">class</span> <span class="title class_">java</span>/lang/Throwable ]</span><br><span class="line">        frame_type = <span class="number">250</span> <span class="comment">/* chop */</span></span><br><span class="line">          offset_delta = <span class="number">4</span></span><br><span class="line">&#125;</span><br><span class="line">SourceFile: <span class="string">&quot;TestSync.java&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/04/16/e6RK9MfqbA2BLpy.png" alt="image-20200906171829072"></p>
<p>在JVM里，对象锁就是实现monitor机制的一种方式。entermonitor就是获得某个对象的lock(owner是当前线程)，leavemonitor就是释放某个对象的锁。</p>
<h3 id="对象头"><a href="#对象头" class="headerlink" title="对象头"></a>对象头</h3><p><code>synchronized</code>使用的锁是存在于对象头中。</p>
<p><img src="https://s2.loli.net/2022/04/16/XOl6P29qpFWHKrY.png" alt="img"></p>
<p>如果锁是数组，则使用三个字宽来表示对象头，如果是非数组，则用两个字宽来表示。</p>
<p>1字宽&#x3D;4字节&#x3D;32bit</p>
<table>
<thead>
<tr>
<th align="center">长度</th>
<th align="center">内容</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">32&#x2F;64bit</td>
<td align="center">Mark word</td>
<td align="center">存储对象的hashcode或锁信息等</td>
</tr>
<tr>
<td align="center">32&#x2F;64bit</td>
<td align="center">Class Metadata Address</td>
<td align="center">存储到对象数据类型的指针</td>
</tr>
<tr>
<td align="center">32&#x2F;64bit</td>
<td align="center">Array length</td>
<td align="center">如果是数组，则表示数组的长度*</td>
</tr>
</tbody></table>
<h3 id="Mark-Word"><a href="#Mark-Word" class="headerlink" title="Mark Word"></a>Mark Word</h3><p>Java对象头Mark word中默认存储以下内容：</p>
<ul>
<li>HashCode</li>
<li>分代年龄</li>
<li>锁标记位</li>
</ul>
<table>
<thead>
<tr>
<th align="center">锁状态</th>
<th align="center">25bit</th>
<th align="center">4bit</th>
<th align="center">1bit是否是偏向锁</th>
<th align="center">2bit锁标志位</th>
</tr>
</thead>
<tbody><tr>
<td align="center">无锁状态</td>
<td align="center">对象的hashCode</td>
<td align="center">对象分代年龄</td>
<td align="center">0</td>
<td align="center">01</td>
</tr>
</tbody></table>
<p>在运行期间，Mark Word里存储的数据会随着锁标志位的改变而改变，可能有以下四种情况</p>
<p><strong>32位虚拟机</strong></p>
<p><img src="https://s2.loli.net/2022/04/16/aL2FyzqT7Dh5NlQ.png" alt="image-20200610135728528"></p>
<p><strong>64位虚拟机</strong></p>
<p><img src="https://s2.loli.net/2022/04/16/JmFQd8HaOR9uCSN.png" alt="image-20200610141406509"></p>
<blockquote>
<p>一些名词解释：</p>
<p>identity hash code是指<strong>不经重写</strong>过由jvm计算的hashcode*</p>
<p>unused：未使用的</p>
<p>hashcode：上文提到的<strong>identity</strong> hash code，本文出现的hashcode都是指identity hash code</p>
<p>thread: 偏向锁记录的线程标识</p>
<p>epoch: 验证偏向锁有效性的时间戳</p>
<p>age：分代年龄</p>
<p>biased_lock 偏向锁标志</p>
<p>lock 锁标志</p>
<p>pointer_to_lock_record 轻量锁lock record指针</p>
<p>pointer_to_heavyweight_monitor 重量锁monitor指针</p>
</blockquote>
<h3 id="Lock-Record"><a href="#Lock-Record" class="headerlink" title="Lock Record"></a>Lock Record</h3><p>当线程访问到同步代码块，如果锁对象的锁标志位为01（无锁状态），则会在线程栈中创建<strong>Lock Record</strong>（<strong>锁记录</strong>）空间，用于存储Mark Word的拷贝。官方称之为<strong>Displaced Mark Word</strong>。</p>
<p><strong>Lock Record是线程私有的数据结构</strong>，每个线程都拥有一个可用的Lock Record列表，同时还有个全局的可用列表。当该线程拥有，会将锁对象的对象头中的Mark Word拷贝一份到其中一个Lock Record中。</p>
<p><strong>每一个被锁住的对象Mark Word都会和一个Lock Record关联（对象头的MarkWord中的Lock Word指向Lock Record的起始地址），同时Lock Record中有一个Owner字段存放拥有该锁的线程的唯一标识（或者<code>object mark word</code>），表示该锁被这个线程占用</strong>。</p>
<p>如下图所示为Lock Record的内部结构：</p>
<table>
<thead>
<tr>
<th align="center">Lock Record</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Owner</td>
<td align="center">初始时为NULL表示当前没有任何线程拥有该monitor record，<strong>当线程成功拥有该锁后保存线程唯一标识</strong>，当锁被释放时又设置为NULL</td>
</tr>
<tr>
<td align="center">EntryQ</td>
<td align="center">关联一个系统互斥锁（semaphore），<strong>阻塞所有试图锁住monitor record失败的线程</strong></td>
</tr>
<tr>
<td align="center">RcThis</td>
<td align="center"><strong>表示blocked或waiting在该monitor record上的所有线程的个数</strong></td>
</tr>
<tr>
<td align="center">Nest</td>
<td align="center">用来实现 <strong>重入锁的计数</strong></td>
</tr>
<tr>
<td align="center">HashCode</td>
<td align="center">保存从对象头拷贝过来的HashCode值（可能还包含GC age）</td>
</tr>
<tr>
<td align="center">Candidate</td>
<td align="center">用来避免不必要的阻塞或等待线程唤醒，因为每一次只有一个线程能够成功拥有锁，如果每次前一个释放锁的线程唤醒所有正在阻塞或等待的线程，会引起不必要的上下文切换（从阻塞到就绪然后因为竞争锁失败又被阻塞）从而导致性能严重下降。<br/><strong>Candidate只有两种可能的值，0表示没有需要唤醒的线程1表示要唤醒一个继任线程来竞争锁。</strong></td>
</tr>
</tbody></table>
<h3 id="锁类型与锁的升级"><a href="#锁类型与锁的升级" class="headerlink" title="锁类型与锁的升级"></a>锁类型与锁的升级</h3><p>Java中锁共分为四种状态，级别从低到高分别为：<strong>无锁状态</strong>、<strong>偏向锁</strong>、<strong>轻量级锁</strong>、<strong>重量级锁</strong></p>
<p>Java SE1.6为了减少获得锁和释放锁所带来的性能消耗，引入了“偏向锁”和“轻量级锁”。</p>
<p>锁可以被升级，但不能被降级。当偏向锁升级为轻量级锁后，无法降级为偏向锁。目的是为了提高获得锁和释放锁的效率。</p>
<h4 id="偏向锁"><a href="#偏向锁" class="headerlink" title="偏向锁"></a>偏向锁</h4><p>并发访问一个同步代码块，在很多情况下，往往是同一个线程获取到这个代码块的执行权。为了降低进入同步代码块时获取锁造成的损耗，于是JDK1.6引入了偏向锁。</p>
<p>轻量级锁的获取及释放依赖多次CAS原子指令，而偏向锁只需要在置换ThreadID的时候依赖一次CAS原子指令即可。<strong>适用于同一个线程多次访问同一个同步代码块。</strong></p>
<p>偏向锁只有遇到其他线程尝试竞争偏向锁时，持有偏向锁的线程才会释放锁，线程不会主动释放偏向锁。</p>
<p>偏向锁的撤销，需要等待全局安全点（在这个时间点上没有字节码正在执行），它会首先暂停拥有偏向锁的线程，然后检查持有偏向锁的线程是否活着，如果线程不处于活动状态，则将对象头设置成<strong>无锁状态</strong> （标志位为“01”） ，若处于活动状态，则膨胀为<strong>轻量级锁</strong>（标志位为“00”）。最后唤醒暂停的线程 。</p>
<p>此时的轻量级锁由原持有偏向锁的线程所有，并继续执行其同步代码，而正在竞争的线程会自旋等待该轻量级锁。（对于一个已经竞争到同步锁的线程，在还没有走出同步块的时候，时间片结束不会导致释放锁。）</p>
<p>流程可见下图：</p>
<img src="https://s2.loli.net/2022/04/16/dixMak4HhE1Fl3e.png" alt="偏向锁"  />

<h5 id="关闭偏向锁"><a href="#关闭偏向锁" class="headerlink" title="关闭偏向锁"></a>关闭偏向锁</h5><p>Java6与Java7中默认启用偏向锁，但是它在应用程序启动几秒钟之后才激活，如有必要可以使用JVM参数来关闭延迟：<code>-XX:BiasedLockingStartupDelay=0  </code>。</p>
<p>如果确定应用程序所有的锁基本都出在竞争状态下，则可以选择关闭偏向锁：<code>-XX:-UseBiasedLocking=false  </code>，此时，当申请锁时都会进入轻量级锁状态。</p>
<h4 id="轻量级锁"><a href="#轻量级锁" class="headerlink" title="轻量级锁"></a>轻量级锁</h4><p>当偏向锁发生多线程竞争时，会膨胀成轻量级锁。</p>
<p>在代码进入同步块时，如果此同步对象未被锁定，锁标志位“01”，虚拟机将在当前线程的栈帧中建立一个名为<strong>锁记录Lock Record</strong>的空间用于存储锁对象对象头中Mark Word的拷贝</p>
<p>在线程栈帧中创建Lock Record空间，并在其中创建所对象头Mark Word的拷贝，修改拷贝的Mark Word中的Owner内容为指向锁对象的指针。</p>
<p>修改锁标志位为00，将指向线程ID的指针记录到锁对象头中。</p>
<p><img src="https://s2.loli.net/2022/04/16/E18VDtjs6hUbHg3.jpg" alt="preview"></p>
<img src="https://s2.loli.net/2022/04/16/CRFvQy9LVbu6UYh.png" alt="轻量锁及膨胀流程图"  />

<h4 id="重量级锁"><a href="#重量级锁" class="headerlink" title="重量级锁"></a>重量级锁</h4><p>重量级锁依赖于Monitor实现，而Java中的ObjectMonitor基于系统底层的Mutex Lock（互斥锁）来实现。</p>
<p><code>Mutex Lock</code>保护代码临界区在同一时刻只有一个线程可以访问。如果线程访问时已上锁，则新线程进入阻塞（BLOCKED）。代码块执行结束后，需要对<code>Mutex Lock</code>进行解锁。</p>
<p>Java线程进入阻塞或重新唤醒，需要操作系统从用户态转换为核心态，而频繁切换较为耗费系统资源，所以在JDK1.6之前，synchronized仅依赖于Monitor，频繁的状态切换导致执行效率较低，所以在1.6之后，在虚拟机层面引入了偏向锁以及轻量级锁，加入了直接判断线程ID以及通过一定时间的自旋，来避免使用重量级锁。</p>
<h4 id="三种锁的对比"><a href="#三种锁的对比" class="headerlink" title="三种锁的对比"></a>三种锁的对比</h4><table>
<thead>
<tr>
<th></th>
<th>优势</th>
<th>劣势</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td>偏向锁</td>
<td>仅通过一次CAS操作markword填充当前线程的id，是则获得锁，不是则撤销并升级为轻量级锁。</td>
<td>如果程序运行存在过多的锁竞争，则会带来锁撤销的性能开销。</td>
<td>代码块偶尔发生竞争。</td>
</tr>
<tr>
<td>轻量级锁</td>
<td>如果线程未能获取到锁，则会进入高速的CAS自旋，而不进入阻塞，节省了线程之间上下文切换的开销。</td>
<td>自旋如果长时间竞争不到锁会消耗cpu。</td>
<td>代码块占用锁的时间较短。</td>
</tr>
<tr>
<td>重量级锁</td>
<td>不使用自旋，节约cpu。</td>
<td>依赖于Monitor，monitor依赖于系统底层Mutex Lock，用户态与核心态的切换降低了代码执行效率。</td>
<td>系统中竞争多，且锁占用时间较长。</td>
</tr>
</tbody></table>
<p>附：全流程</p>
<p><img src="https://s2.loli.net/2022/04/16/w17ZxmlzrBIOHuq.jpg" alt="img"></p>
<hr>
<blockquote>
<p>参考</p>
<p>&lt;&lt;<a target="_blank" rel="noopener" href="https://book.douban.com/subject/26591326/">Java并发编程的艺术</a>&gt;&gt;</p>
<p><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/java/j-lo-synchronized/">探索 Java 同步机制</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/6fe4bc3374a2">Java 多线程（二）－Monitor</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/5b90cd7c5188255c877e20c8">Synchronized原理</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wade-luffy/p/5969418.html">偏向锁，轻量级锁，自旋锁，重量级锁的详细介绍</a></p>
<p><a target="_blank" rel="noopener" href="https://tech.meituan.com/2018/11/15/java-lock.html">不可不说的Java“锁”事</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/javaminer/p/3889023.html">JVM内部细节之一：synchronized关键字及实现细节（轻量级锁Lightweight Locking）</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/5b4eec7df265da0fa00a118f">啃碎并发（七）：深入分析Synchronized原理</a></p>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag"># 多线程</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/09/06/Java%E5%B9%B6%E5%8F%91-%E6%AD%BB%E9%94%81%E7%9A%84%E5%8E%9F%E5%9B%A0%E5%8F%8A%E5%8F%91%E7%94%9F%E6%97%B6%E5%A6%82%E8%A7%A3%E5%86%B3/" rel="prev" title="Java并发-死锁的原因及如何解决">
                  <i class="fa fa-chevron-left"></i> Java并发-死锁的原因及如何解决
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/09/06/Java%E5%B9%B6%E5%8F%91-CPU%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="next" title="Java并发-CPU如何实现的多线程">
                  Java并发-CPU如何实现的多线程 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">你丶一顾倾城</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  




<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"skywaterliu/skywaterliu.github.io","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js"></script>

</body>
</html>
