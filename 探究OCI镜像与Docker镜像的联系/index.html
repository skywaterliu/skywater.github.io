<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"skywaterliu.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.11.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="探究OCI镜像与Docker镜像的联系 从熟知的Docker出发 目前，容器化技术已经广泛普及了，而谈到容器，我想大多数人的第一反应就是Docker了。  Docker给我们带来了很多好处，优化了CI&#x2F;CD流程，可以实现云原生，纳入容器编排等等。  回想下Docker中的概念，我们是如何使用Docker的？一般开发人员会编写Dockerfile，用来定义一个镜像，然后将Dockerfile生成的镜">
<meta property="og:type" content="article">
<meta property="og:title" content="探究OCI镜像与Docker镜像的联系">
<meta property="og:url" content="https://skywaterliu.github.io/%E6%8E%A2%E7%A9%B6OCI%E9%95%9C%E5%83%8F%E4%B8%8EDocker%E9%95%9C%E5%83%8F%E7%9A%84%E8%81%94%E7%B3%BB/index.html">
<meta property="og:site_name" content="安之一隅">
<meta property="og:description" content="探究OCI镜像与Docker镜像的联系 从熟知的Docker出发 目前，容器化技术已经广泛普及了，而谈到容器，我想大多数人的第一反应就是Docker了。  Docker给我们带来了很多好处，优化了CI&#x2F;CD流程，可以实现云原生，纳入容器编排等等。  回想下Docker中的概念，我们是如何使用Docker的？一般开发人员会编写Dockerfile，用来定义一个镜像，然后将Dockerfile生成的镜">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://github.com/opencontainers/image-spec/raw/main/img/media-types.png">
<meta property="og:image" content="https://s2.loli.net/2022/03/07/1GFZmH7u3CcznsX.png">
<meta property="og:image" content="https://s2.loli.net/2022/03/07/HTjNYirAMGcbSFe.png">
<meta property="og:image" content="https://s2.loli.net/2022/03/08/kZbVKm6wORYdhUv.png">
<meta property="og:image" content="https://s2.loli.net/2022/03/08/8iE3jKtquHZnkDg.png">
<meta property="og:image" content="https://s2.loli.net/2022/03/08/gPRqIWsdzpNBw2r.png">
<meta property="og:image" content="https://s2.loli.net/2022/03/07/twSsnN7bgXOhd35.png">
<meta property="article:published_time" content="2021-03-08T12:18:00.000Z">
<meta property="article:modified_time" content="2022-04-16T09:09:14.926Z">
<meta property="article:author" content="你丶一顾倾城">
<meta property="article:tag" content="OCI">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/opencontainers/image-spec/raw/main/img/media-types.png">


<link rel="canonical" href="https://skywaterliu.github.io/%E6%8E%A2%E7%A9%B6OCI%E9%95%9C%E5%83%8F%E4%B8%8EDocker%E9%95%9C%E5%83%8F%E7%9A%84%E8%81%94%E7%B3%BB/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://skywaterliu.github.io/%E6%8E%A2%E7%A9%B6OCI%E9%95%9C%E5%83%8F%E4%B8%8EDocker%E9%95%9C%E5%83%8F%E7%9A%84%E8%81%94%E7%B3%BB/","path":"探究OCI镜像与Docker镜像的联系/","title":"探究OCI镜像与Docker镜像的联系"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>探究OCI镜像与Docker镜像的联系 | 安之一隅</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">安之一隅</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">莫听穿林打叶声，何妨吟啸且徐行。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A2%E7%A9%B6OCI%E9%95%9C%E5%83%8F%E4%B8%8EDocker%E9%95%9C%E5%83%8F%E7%9A%84%E8%81%94%E7%B3%BB"><span class="nav-number">1.</span> <span class="nav-text">探究OCI镜像与Docker镜像的联系</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E7%86%9F%E7%9F%A5%E7%9A%84Docker%E5%87%BA%E5%8F%91"><span class="nav-number">1.1.</span> <span class="nav-text">从熟知的Docker出发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OCI%E7%AE%80%E4%BB%8B"><span class="nav-number">1.2.</span> <span class="nav-text">OCI简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AE%B9%E5%8F%AF%E5%AF%BB%E5%9D%80%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8"><span class="nav-number">1.3.</span> <span class="nav-text">内容可寻址文件存储</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CAS%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.3.1.</span> <span class="nav-text">CAS如何实现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#image-spec%EF%BC%88%E9%95%9C%E5%83%8F%E6%A0%87%E5%87%86%EF%BC%89"><span class="nav-number">1.4.</span> <span class="nav-text">image-spec（镜像标准）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AA%92%E4%BD%93%E7%B1%BB%E5%9E%8B%EF%BC%88mediaType%EF%BC%89"><span class="nav-number">1.4.1.</span> <span class="nav-text">媒体类型（mediaType）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%95%9C%E5%83%8F%E7%BB%93%E6%9E%84"><span class="nav-number">1.4.2.</span> <span class="nav-text">镜像结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Image-Layout"><span class="nav-number">1.4.3.</span> <span class="nav-text">Image Layout</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Image-Index"><span class="nav-number">1.4.4.</span> <span class="nav-text">Image Index</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Image-Manifest"><span class="nav-number">1.4.5.</span> <span class="nav-text">Image Manifest</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Image-Configuration"><span class="nav-number">1.4.6.</span> <span class="nav-text">Image Configuration</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Filesystem-Layer"><span class="nav-number">1.4.7.</span> <span class="nav-text">Filesystem Layer</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.5.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">你丶一顾倾城</p>
  <div class="site-description" itemprop="description">嗨害嗨！</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">26</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/skywaterliu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;skywaterliu" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:liutianshui17@gmail.com" title="E-Mail → mailto:liutianshui17@gmail.com" rel="noopener" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://skywaterliu.github.io/%E6%8E%A2%E7%A9%B6OCI%E9%95%9C%E5%83%8F%E4%B8%8EDocker%E9%95%9C%E5%83%8F%E7%9A%84%E8%81%94%E7%B3%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="你丶一顾倾城">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安之一隅">
      <meta itemprop="description" content="嗨害嗨！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="探究OCI镜像与Docker镜像的联系 | 安之一隅">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          探究OCI镜像与Docker镜像的联系
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-08 20:18:00" itemprop="dateCreated datePublished" datetime="2021-03-08T20:18:00+08:00">2021-03-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-16 17:09:14" itemprop="dateModified" datetime="2022-04-16T17:09:14+08:00">2022-04-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%B9%E5%99%A8%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">容器化</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%B9%E5%99%A8%E5%8C%96/Cloud-Native/" itemprop="url" rel="index"><span itemprop="name">Cloud Native</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="探究OCI镜像与Docker镜像的联系"><a href="#探究OCI镜像与Docker镜像的联系" class="headerlink" title="探究OCI镜像与Docker镜像的联系"></a>探究OCI镜像与Docker镜像的联系</h2><h3 id="从熟知的Docker出发"><a href="#从熟知的Docker出发" class="headerlink" title="从熟知的Docker出发"></a>从熟知的Docker出发</h3><p>目前，容器化技术已经广泛普及了，而谈到容器，我想大多数人的第一反应就是Docker了。</p>
<p>Docker给我们带来了很多好处，优化了CI&#x2F;CD流程，可以实现云原生，纳入容器编排等等。</p>
<p>回想下Docker中的概念，我们是如何使用Docker的？一般开发人员会编写Dockerfile，用来定义一个镜像，然后将Dockerfile生成的镜像推送到远程仓库，最终根据需要通过pull镜像生成容器运行起来。如果是云原生应用，那这个pull的动作可能是k8s做的。同时，k8s集群的node环境中需要有Docker守护进程。</p>
<p>可以说，Docker的功能十分强大，包裹了整个云原生应用的开发生命周期，似乎我们如果要使用容器技术就离不开它，可事实真的是这样么？</p>
<p>最近，容器编排界的事实标准k8s发布了这样一则公告：<strong>自 v1.20 起放弃对 Docker 的支持，届时用户将收到 Docker 弃用警告，并需要改用其他容器运行时。</strong></p>
<blockquote>
<p>Docker support in the kubelet is now deprecated and will be removed in a future release. The kubelet uses a module called “dockershim” which implements CRI support for Docker and it has seen maintenance issues in the Kubernetes community. We encourage you to evaluate moving to a container runtime that is a full-fledged implementation of CRI (v1alpha1 or v1 compliant) as they become available. (<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/pull/94624">#94624</a>, <a target="_blank" rel="noopener" href="https://github.com/dims">@dims</a>) [SIG Node]</p>
<p>引用自<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md#deprecation">K8S官方文档</a></p>
</blockquote>
<p>k8s放弃了kubelet中对Docker的支持，鼓励我们替换为个完整实现CRI的容器运行时。虽然只是放弃了“Docker的容器运行时”，但显而易见，Docker并非不可取代的。</p>
<p>容器运行时只是整个云原生应用生命周期依赖的一个点而已，如果以后整个生命周期都弃用了Docker，那原先构建的镜像还能使用么？如何能继续运行呢？</p>
<p>这就需要容器技术将每个功能点剥离，并形成行业规范，镜像应该怎么描述、容器运行时应该如何解析镜像与运行、网络应该如何构建，都需要一个统一的接口，</p>
<p>早在好几年前，业界就意识到了这个问题，从而诞生了OCI。</p>
<h3 id="OCI简介"><a href="#OCI简介" class="headerlink" title="OCI简介"></a>OCI简介</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://opencontainers.org/faq/">https://opencontainers.org/faq/</a></p>
</blockquote>
<p>OCI全称Open Container Initiative，翻译过来就是开放容器标准。为了减少项目的摩擦而导致的内耗，以及用户渴求一个容器技术不强绑定于一个具体厂商，且能跨越各种硬件、操作系统、CPU架构、公有云，2015年Docker和当时其他“友商”进行了讨论，大家开发容器技术，都得按照同一个模子来，就像软件开发时定一个接口，具体实现交由开发人员一样。Docker构建的镜像，也可以发布到其他容器厂商的镜像仓库，并run在其他厂商的运行时，得益于大家都是先了这个接口。</p>
<p>OCI包含了以下两部分：</p>
<ul>
<li><p><strong>镜像规范（image-spec）</strong></p>
<p>规定应该以何种格式存储、分发镜像。</p>
<p>也就是，被打成的镜像内容具体需要长什么样。目录结构，结构信息元文件、版本等等，应该如何去定义，在哪定义。</p>
</li>
<li><p><strong>运行时规范（runtime-spec）</strong></p>
<p>规定了如何运行在磁盘上解压的“文件系统包”。</p>
<p>什么是文件系统包？比如，将linux整个系统，用tar工具打成了一个tar.gz包。这个包就是“文件系统包”。它将包含在镜像当中，当解压出来可被OCI Runtime运行了，就被称为“<strong>OCI Runtime Bundle</strong>”。</p>
</li>
</ul>
<h3 id="内容可寻址文件存储"><a href="#内容可寻址文件存储" class="headerlink" title="内容可寻址文件存储"></a>内容可寻址文件存储</h3><p>在讲镜像规范前，需要学习一个知识点：<strong>内容可寻址文件存储</strong>，简称<strong>“CAS”</strong>。</p>
<p>我们平时使用的系统，如windows，linux，均是通过路径来确定一个文件内容，比如<code>D:/temp/temp.txt</code>。访问文件的方式也是路径加上文件名。这样会有一个问题，就是无法识别这个文件是否被修改了，它还是最初的它么？当然，文件右键可以看到修改时间，但这并非存储本省的寻址提供的能力，如果我没有权限查看它的修改时间呢？是不是就不能知道了。于是，存在这样一种存储方式，我们通过路径就可以确定一个文件，且这个文件一定是我们需要的，未被修改的文件，就是<strong>内容可寻址文件存储</strong>。</p>
<h4 id="CAS如何实现"><a href="#CAS如何实现" class="headerlink" title="CAS如何实现"></a>CAS如何实现</h4><p>如何唯一标识一个文件？一般会想到使用<strong>文件摘要算法</strong>。常见的算法如SHA256，SHA512。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@skywater ~]# sha256sum temp.sh </span><br><span class="line">f6484a310090a07d701b33b9a3df060dc157a510408a5e933b86c6a40aec0cf2  temp.sh</span><br></pre></td></tr></table></figure>

<p><strong>CAS</strong>就是使用了文件摘要算法，如果我们将系统中所有文件的摘要作为key，而文件内容作为value，就可以形成一张hash表。对整个系统目录进行打包后再hash，作为一个tag，那么这个tag将会保证内容是不变的。</p>
<p>而换句话来说，如果一个系统经常发生变化，那么就不适合使用这样的存储方式，应为变动会引起hash变化，导致重新计算的负担。</p>
<p>容器技术中的镜像文件就恰恰有这样一个需求，那就是<strong>保证不可变性</strong>。我今天使用了这个镜像作为基础建立了另一个镜像，明天这个基础居然被人改了？？导致我的应用出现了完全不可预知的问题，这是绝对不允许的。所以，<strong>CAS</strong>很适合作为镜像的存储方式。</p>
<h3 id="image-spec（镜像标准）"><a href="#image-spec（镜像标准）" class="headerlink" title="image-spec（镜像标准）"></a>image-spec（镜像标准）</h3><p>OCI image-spec最早就是由当时的容器领头羊Docker贡献出来的，所以在后来的演化过程中，Docker镜像本身也是符合OCI规范的。</p>
<p>整体来看OCI image-spec，需要包含以下内容：</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/main/manifest.md">Image Manifest</a> </p>
<p>描述构成容器镜像的组件的清单文件</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/main/image-index.md">Image Index</a></p>
<p>图像清单的注释索引 </p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/main/image-layout.md">Image Layout</a></p>
<p>表示图像内容的文件系统布局 </p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/main/layer.md">Filesystem Layer</a></p>
<p>描述容器文件系统的变更集 </p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/main/config.md">Image Configuration</a></p>
<p>定义了运行时bundle中的layer顺序以及配置信息</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/main/conversion.md">Conversion</a></p>
<p>将定义标签转换成实际的运行时字段以及指令，比如image中的<code>Config.WorkingDir</code>转换为运行时的<code>process.cwd</code></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/main/descriptor.md">Descriptor</a></p>
<p>元数据描述对象，使用key-value形式表示。</p>
<p>必须存在的属性包括：<code>mediaType</code>，<code>digest</code>，<code>size</code>。</p>
<p>可选属性包括<code>urls</code>，<code>annotations</code>，<code>data</code>。</p>
</li>
</ul>
<p>当然，作为具体的OCI image-spec实现，Docker也会有一些不一样的点。</p>
<p>这里将OCI标准与Docker镜像进行对比，把OCI image-spec中的标识符一一对应到Docker镜像，这样可以更好的理解OCI。</p>
<h4 id="媒体类型（mediaType）"><a href="#媒体类型（mediaType）" class="headerlink" title="媒体类型（mediaType）"></a>媒体类型（mediaType）</h4><p>媒体类型常见于http请求的hearder中，用来定义所指向的资源类型。通过mediaType，我们就可以使用正确的方式去解析数据。如果是gzip类型，那就需要用tar工具解压，如果是excel类型，就需要用Office、WPS之类的软件打开。镜像文件、以及镜像文件中包含的各种内容都有它们对应的mediaType。</p>
<p>后续涉及到容器内容各个点时再明确每个内容对应的媒体类型。</p>
<p>各媒体类型间的依赖关系如下：</p>
<p><img src="https://github.com/opencontainers/image-spec/raw/main/img/media-types.png" alt="img"></p>
<h4 id="镜像结构"><a href="#镜像结构" class="headerlink" title="镜像结构"></a>镜像结构</h4><p><img src="https://s2.loli.net/2022/03/07/1GFZmH7u3CcznsX.png" alt="img"></p>
<blockquote>
<p>该图引用自<a target="_blank" rel="noopener" href="https://guide.daocloud.io/dcs/docker-9153976.html">https://guide.daocloud.io/dcs/docker-9153976.html</a></p>
</blockquote>
<p>Docker镜像由Dockerfile生成，通常会选择一个镜像作为基础镜像，如图上的ubuntu:14.04，随后根据我们的指令，向上依次堆叠层（layer）。最顶层为Read-write Layer，即读写层，可以挂在到宿主机。</p>
<p>或许这么讲还是有些抽象，我们直接把Docker的image下载到本地来分析。</p>
<p>构建使用的Dockerfile如下。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jdk-alpine</span><br><span class="line"><span class="keyword">MAINTAINER</span> <span class="string">&quot;skywater&quot;</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> description=<span class="string">&quot;testImage&quot;</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> /tmp/logs</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./target/*.jar /app/app.jar</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@skywater docker]# docker save 106.15.92.100:5000/lts/springboot-demo:v2 | gzip &gt; springboot-demo.tar.gz</span><br><span class="line">[root@skywater docker]# mkdir springboot-demo &amp;&amp; tar -zxvf springboot-demo.tar.gz -C springboot-demo</span><br><span class="line">[root@skywater docker]# tree springboot-demo</span><br></pre></td></tr></table></figure>

<p>解压后目录结构</p>
<p><img src="https://s2.loli.net/2022/03/07/HTjNYirAMGcbSFe.png" alt="image-20220307212727000"></p>
<p>可以看到，镜像内容中包含了一个manifest，以及多个包含了layer.tar的文件夹。这里每个layer.tar就对应了图上的每一层，排列顺序，以及层的配置信息，就在<code>manifest.json</code>以及每个文件夹中的<code>json</code>当中。</p>
<p>了解了镜像文件的大概结构，我们再对照OCI规范深入去看一下每一个文件的作用。</p>
<h4 id="Image-Layout"><a href="#Image-Layout" class="headerlink" title="Image Layout"></a>Image Layout</h4><p>这时一个整体结构的定义，OCI定义中，image内容结构需要包含以下内容：</p>
<p>index.json文件，oci-layout文件，以及blobs目录。</p>
<p>结构类似于：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">blobs</span><br><span class="line">  	|--- 987fads67897gadfas</span><br><span class="line">  	|--- 8908a80g7b65cvb223</span><br><span class="line">oci-layout</span><br><span class="line">index.json</span><br></pre></td></tr></table></figure>

<p>然而，从解压后的镜像内容来看，Docker目前没有适配这块规范，所以并没有这些文件与目录。</p>
<p>虽然Docker镜像并不完全符合OCI规范，譬如这里的image-layout，但并不意味着与OCI不兼容，OCI需要的信息，会以其他的结构展现在Docker镜像结构中。</p>
<p>如果需要获取的话，可以通过工具将docker镜像转换为oci镜像，使用skopeo工具：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">skopeo copy docker://springboot-demo:v1 oci:springboot-demo</span></span><br></pre></td></tr></table></figure>

<p>查看本地目录springboot-demo</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@skywater tmp]# tree springboot-demo/ --du</span><br><span class="line">springboot-demo/</span><br><span class="line">├── [   75877939]  blobs</span><br><span class="line">│   └── [   75877919]  sha256</span><br><span class="line">│       ├── [      19413]  099e5f0c6733b339ec37c98f725fae41b872ebc9064619f7f44ad93cf939f5ea</span><br><span class="line">│       ├── [        249]  0e735f96c2df7edc67964a683c77805c0285371c0e71bacd491f38011b29829b</span><br><span class="line">│       ├── [   73006326]  4b2f0c876f4462376e74633289dbbb6e32d5c542ef698bd9f6bf24e97ed22aaf</span><br><span class="line">│       ├── [    2842856]  74f1fcf320dc694abfb36b0c3a7383c09e15fc4edfe76102e71a3224f8ff1ed8</span><br><span class="line">│       ├── [        161]  782e025922b72ccca53e4a386c1f7b784e602294434d4bcc84786dccfc622e40</span><br><span class="line">│       ├── [       3556]  9e63d81810f866d774e2a5b8e6be8d4c283c462214d75be2eede7019d4b03303</span><br><span class="line">│       ├── [        136]  db69bb6d4d2aee35e87908bdafe2428b144513ff8c3b1d1f3744272d11717343</span><br><span class="line">│       └── [       1126]  e6c11218c3533a6c1314bfa3f55acf940d11830ce6e148f4c1004f2a6d508901</span><br><span class="line">├── [        187]  index.json</span><br><span class="line">└── [         31]  oci-layout</span><br><span class="line"></span><br><span class="line">    75878212 bytes used in 2 directories, 10 files</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>index.json</strong></p>
<p><img src="https://s2.loli.net/2022/03/08/kZbVKm6wORYdhUv.png" alt="image-20220308112923586"></p>
<p>其中将包含一个Image index对象，后续再详解Image Index。目前只需要知道，通过index.json就可以找到Image Index的hash位置即可。</p>
</li>
<li><p><strong>oci-layout</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@skywater springboot-demo]# cat oci-layout</span><br><span class="line">&#123;&quot;imageLayoutVersion&quot;: &quot;1.0.0&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>内容很简单，只有一个版本号，这个版本为整个OCI image文件目录布局结构的规划版本，目前使用的是1.0.0。</p>
</li>
<li><p><strong>blobs</strong></p>
<p>包含了使用hash进行查找的镜像配置文件、层内容等信息</p>
</li>
</ul>
<blockquote>
<p> 通过index.sjon，可以定位到各平台对应的manifest的hash位置。再通过manifest，可以找到image-config，而image-config中，又将包含各个layer的具体配置信息，这样就可以将所有内容串联起来，runtime也就知道了容器运行需要的所有基本信息。</p>
</blockquote>
<h4 id="Image-Index"><a href="#Image-Index" class="headerlink" title="Image Index"></a>Image Index</h4><p>镜像索引，这个内容是可选的，一个镜像可能适用于多个平台架构，单个manifest并不能满足要求，所以我们可以提供多个manifest组成一个Image Index，来实现跨平台。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/main/image-index.md">OCI对Image Index的定义</a>概览如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment">// 必选  </span></span><br><span class="line">  <span class="attr">&quot;schemaVersion&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="comment">// 应该被使用</span></span><br><span class="line">  <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.oci.image.index.v1+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="comment">// 必选</span></span><br><span class="line">  <span class="attr">&quot;manifests&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.oci.image.manifest.v1+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">7143</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:e692418e4cbaf90ca69d05a66403747baa33ee08806650b51fab815ad7fc331f&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ppc64le&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.oci.image.manifest.v1+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">7682</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:5b0bcabd1ed22e9fb1310cf6c2dec7cdef19f0ad69efa1f392e94a4333501270&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;amd64&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;annotations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;com.example.key1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;value1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;com.example.key2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;value2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>虽然Docker没有符合Image-Layout规范，但仍然可以找到Image-Layout中指向的Image Index。</strong></p>
<p>在我们上面springboot-demo的例子中体现不出来，没有做跨平台，我们可以换一个dockerhub中的镜像看下其中的内容。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@skywater ~]# docker manifest inspect nginx</span><br></pre></td></tr></table></figure>

<p>以Nginx镜像为例，可以看到一个媒体类型为<code>application/vnd.docker.distribution.manifest.list.v2+json</code>的manifest列表，其实就是对应了Image index，其中属性可以一一对应上。</p>
<p><img src="https://s2.loli.net/2022/03/08/8iE3jKtquHZnkDg.png" alt="image-20220308092044955"></p>
<p><img src="https://s2.loli.net/2022/03/08/gPRqIWsdzpNBw2r.png" alt="image-20220308094504456"></p>
<ul>
<li><p><strong>mediaType</strong></p>
<table>
<thead>
<tr>
<th>Docker</th>
<th>OCI</th>
</tr>
</thead>
<tbody><tr>
<td>application&#x2F;vnd.docker.distribution.manifest.list.v2+json</td>
<td>application&#x2F;vnd.oci.image.index.v1+json</td>
</tr>
</tbody></table>
<p>表示该文件是镜像清单文件。</p>
</li>
<li><p><strong>manifests</strong></p>
<p>manifest列表，对应<strong>特定平台</strong>的manifest，其中会包含platform信息，不同平台架构、系统需要有不同的镜像清单。</p>
<ul>
<li><p><strong>mediaType</strong></p>
<p>即为上文提到的Image Manifest媒体类型</p>
</li>
<li><p><strong>platform</strong></p>
<p>描述镜像运行的环境要求，类似于定义一个软件必须是windows 10 再能用的一样。</p>
</li>
</ul>
</li>
</ul>
<h4 id="Image-Manifest"><a href="#Image-Manifest" class="headerlink" title="Image Manifest"></a>Image Manifest</h4><p>通过Image Index，我们可以找到该镜像在当前平台系统对应的manifest。</p>
<p>Image Index是为了<strong>跨平台</strong>，而相反的，manifest的主要目的，是为<strong>特定架构和操作系统</strong>的<strong>单个容器映像</strong>提供<strong>配置和镜像层集</strong>。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/main/manifest.md#image-manifest-property-descriptions">OCI对manifest的定义</a>概览如下：</p>
<ul>
<li><p>必须属性</p>
<p><strong><code>schemaVersion</code><strong>，</strong><code>mediaType</code></strong> ，**<code>config</code>** ，**<code>layers</code>** ，<strong>layers下的<code>mediaType</code></strong> </p>
</li>
<li><p>可选属性</p>
<p><strong><code>annotations</code></strong></p>
</li>
</ul>
<p>OCI Image Manifest示例如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;schemaVersion&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.oci.image.manifest.v1+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.oci.image.config.v1+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">7023</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:b5b2b2c507a0944348e0303114d8d93aaaa081732b86451d9bce1f432a537bc7&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;layers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.oci.image.layer.v1.tar+gzip&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">32654</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:9834876dcfb05cb167a5c24953eba58c4ac89b1adf57f28f2f9d09af107ee8f0&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.oci.image.layer.v1.tar+gzip&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">16724</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:3c3a4604a545cdc127456d94e421cd355bca5b528f4a9c1905b15da2eb4a4c6b&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.oci.image.layer.v1.tar+gzip&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">73109</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:ec4b8955958665577945c89419d1af06b5f7636b4ac3da7f12184802ad867736&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;annotations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;com.example.key1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;value1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;com.example.key2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;value2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>我们来找一找，Docker中的manifest.json是否包含了这些内容。</p>
<p>读取save到本地的Docker image中的manifest.json内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@skywater docker]# cat springboot-demo/manifest.json | jq</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;Config&quot;: &quot;4a030f9340dfd2456fe7ddaa23dd65571eb2987c8c038e1482adf46fd48b3aa4.json&quot;,</span><br><span class="line">    &quot;RepoTags&quot;: [</span><br><span class="line">      &quot;springboot-demo:v1&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;Layers&quot;: [</span><br><span class="line">      &quot;1a58e6937db044ef6f2e2962a0dc7bef16a6c33fdfc5a0318c39092612a1bd1a/layer.tar&quot;,</span><br><span class="line">      &quot;c12f86d2a60fc27a1d93d555944262fda4ed66e3a3172ac45cd861151a0dc6c1/layer.tar&quot;,</span><br><span class="line">      &quot;98867178f60349f16652222772d086159a6d087fcd50bc32b9d75c23cd01ed8d/layer.tar&quot;,</span><br><span class="line">      &quot;91b1ccb4946286a411dc7e11717ad45e71b9235a6a18f6ec183f79ae3a3693bc/layer.tar&quot;,</span><br><span class="line">      &quot;cc2781c6b5a3376fcfae998304d99c071d5faa6630b13f50e85acfab759d4167/layer.tar&quot;,</span><br><span class="line">      &quot;4409a35858a53e68fd42b6ac63ab0c199ba220817ddc0436559467686f862042/layer.tar&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>可以看到，配置文件以及layer目录均为hash值，也对应了之前所说的<strong>“内容可寻址文件存储”</strong>。</p>
<p>或者，可以使用docker的manifest命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@skywater springboot-demo]# docker manifest inspect --insecure 106.15.92.100:5000/lts/springboot-demo:v1</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/03/07/twSsnN7bgXOhd35.png" alt="image-20220307223018252"></p>
<ul>
<li><p><strong>schemaVersion</strong></p>
<p>代表为v2版本的manifest。ps：v1版本已废弃。</p>
</li>
<li><p><strong>mediaType</strong></p>
<p>第二个标识为上一章节提到的<strong>mediaType</strong>，为<code>application/vnd.docker.distribution.manifest.v2+json</code>，</p>
<p>而在OCI标准中，manifest的mediaType标准值为<code>application/vnd.oci.image.manifest.v1+json</code>，</p>
<p>略有差别，但OCI兼容Docker的这种mediaType。</p>
</li>
<li><p><strong>config</strong></p>
<p>对应OCI标准中的Image Configuration（镜像配置文件）。</p>
<p>这里镜像配置文件的格式为<code>application/vnd.docker.container.image.v1+json</code>，</p>
<p>对应OCI标准中的镜像格式为<code>application/vnd.oci.image.index.v1+json</code>。</p>
<p>OCI兼容Docker镜像配置文件格式。</p>
<p>通过manifest，<strong>可以定位到image config文件hash位置。</strong>这里获取到的hash为<code>4a030f9340dfd2456fe7ddaa23dd65571eb2987c8c038e1482adf46fd48b3aa4.json</code>，可以在镜像内容中找到该文件。后续再进行细节分析。</p>
</li>
<li><p><strong>layers</strong></p>
<p>一个Descriptor Array（描述符数组），描述了文件系统layer的布局，且必须符合堆栈顺序。</p>
<p>可以发现，下载下来的manifest.json中的layer的hash，和使用<code>docker manifest inspect</code>命令解析出来的不一样，原因是下载下来的是tar格式的bundle，而inspect的是tar.gzip格式。</p>
<ul>
<li><p>mediaType</p>
<p>可以看到，其mediaType为<code>application/vnd.docker.image.rootfs.diff.tar.gzip</code>。根据其提供的hash，可以在下载下来的镜像内容目录中，按顺序找到每个对应的layer.tar文件。</p>
</li>
</ul>
</li>
<li><p><strong>annotations</strong></p>
<p>这项在Docker的manifest中没有体现，可以理解为自己给manifest打上一些标记，内容自行定义，但需要符合key-value格式，以及<a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/main/annotations.md#rules">annotation rules</a>规范。</p>
</li>
</ul>
<p>回顾image manifest（镜像清单）的内容，其中定义了这个镜像清单的版本，镜像配置文件的地址，以及每个layer的地址、排列顺序。是一个镜像的整体概览文件。其中每个文件都有他们的mediaType，由于是docker镜像，所以mediaType中都含有docker的标识符（xxx.docker.xxx）。</p>
<h4 id="Image-Configuration"><a href="#Image-Configuration" class="headerlink" title="Image Configuration"></a>Image Configuration</h4><p>根据manifest内容，我们可以查找到该镜像的Image configuration文件。</p>
<p>OCI中，Image Configuration样例如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	// 可选，表示创建镜像的组合日期和时间</span><br><span class="line">    &quot;created&quot;: &quot;2015-10-31T22:22:56.015925234Z&quot;,</span><br><span class="line">    // 可选，表示创建镜像的作者</span><br><span class="line">    &quot;author&quot;: &quot;Alyssa P. Hacker &lt;alyspdev@example.com&gt;&quot;,</span><br><span class="line">    // 必填，表示此镜像运行需要的CPU架构</span><br><span class="line">    &quot;architecture&quot;: &quot;amd64&quot;,</span><br><span class="line">    // 必填，表示此镜像运行的系统</span><br><span class="line">    &quot;os&quot;: &quot;linux&quot;,</span><br><span class="line">    // 可选，将定义容器endpoint相关参数。</span><br><span class="line">    &quot;config&quot;: &#123;</span><br><span class="line">        &quot;User&quot;: &quot;alice&quot;,</span><br><span class="line">        &quot;ExposedPorts&quot;: &#123;</span><br><span class="line">            &quot;8080/tcp&quot;: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Env&quot;: [</span><br><span class="line">            &quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;,</span><br><span class="line">            &quot;FOO=oci_is_a&quot;,</span><br><span class="line">            &quot;BAR=well_written_spec&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;Entrypoint&quot;: [</span><br><span class="line">            &quot;/bin/my-app-binary&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;Cmd&quot;: [</span><br><span class="line">            &quot;--foreground&quot;,</span><br><span class="line">            &quot;--config&quot;,</span><br><span class="line">            &quot;/etc/my-app.d/default.cfg&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;Volumes&quot;: &#123;</span><br><span class="line">            &quot;/var/job-result-data&quot;: &#123;&#125;,</span><br><span class="line">            &quot;/var/log/my-app-logs&quot;: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;WorkingDir&quot;: &quot;/home/alice&quot;,</span><br><span class="line">        &quot;Labels&quot;: &#123;</span><br><span class="line">            &quot;com.example.project.git.url&quot;: &quot;https://example.com/project.git&quot;,</span><br><span class="line">            &quot;com.example.project.git.commit&quot;: &quot;45a939b2999782a3f005621a8d0f29aa387e1d6b&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    // 必填，定义image需要用到的layer的地址</span><br><span class="line">    &quot;rootfs&quot;: &#123;</span><br><span class="line">      &quot;diff_ids&quot;: [</span><br><span class="line">      	// layer归档的hash，顺序为layer从底到顶的顺序，即diff_ids[0]对应的layer处于image最底层</span><br><span class="line">        &quot;sha256:c6f988f4874bb0add23a778f753c65efe992244e148a1d2ec2a8b664fb66bbd1&quot;,</span><br><span class="line">        &quot;sha256:5f70bf18a086007016e948b04aed3b82103a36bea41755b6cddfaf10ace3c6ef&quot;</span><br><span class="line">      ],</span><br><span class="line">      // 必填，且必须是layers，验证时如果出现未知值将会抛出错误</span><br><span class="line">      &quot;type&quot;: &quot;layers&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    // 可选的，用来描述层的历史信息</span><br><span class="line">    &quot;history&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;created&quot;: &quot;2015-10-31T22:22:54.690851953Z&quot;,</span><br><span class="line">        &quot;created_by&quot;: &quot;/bin/sh -c #(nop) ADD file:a3bc1e842b69636f9df5256c49c5374fb4eef1e281fe3f282c65fb853ee171c5 in /&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;created&quot;: &quot;2015-10-31T22:22:55.613815829Z&quot;,</span><br><span class="line">        &quot;created_by&quot;: &quot;/bin/sh -c #(nop) CMD [\&quot;sh\&quot;]&quot;,</span><br><span class="line">        &quot;empty_layer&quot;: true</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;created&quot;: &quot;2015-10-31T22:22:56.329850019Z&quot;,</span><br><span class="line">        &quot;created_by&quot;: &quot;/bin/sh -c apk add curl&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>大体了解的OCI中的Image Configuration，我们来看下Docker中的有何区别。</p>
<p>首先需要找到Docker中的Image Configuration在哪，根据Manifest中的描述，其位置在<code>sha256:4a030f9340dfd2456fe7ddaa23dd65571eb2987c8c038e1482adf46fd48b3aa4</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@skywater springboot-demo]# ls -l|grep 4a030f9340d</span><br><span class="line">-rw-r--r-- 1 root root 4695 Feb 14 17:01 4a030f9340dfd2456fe7ddaa23dd65571eb2987c8c038e1482adf46fd48b3aa4.json</span><br></pre></td></tr></table></figure>

<p>可以看到，springboot-demo目录下确实有一个这个文件。</p>
<p>查看其内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;amd64&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\&quot;skywater\&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Hostname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Domainname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;User&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AttachStdin&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AttachStdout&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AttachStderr&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ExposedPorts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;8080/tcp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Tty&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;OpenStdin&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;StdinOnce&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Env&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/lib/jvm/java-1.8-openjdk/jre/bin:/usr/lib/jvm/java-1.8-openjdk/bin&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;LANG=C.UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;JAVA_HOME=/usr/lib/jvm/java-1.8-openjdk&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;JAVA_VERSION=8u212&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;JAVA_ALPINE_VERSION=8.212.04-r0&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Cmd&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:2b6a6388a9a8cc96d4b34abcf222b981a9abd86e999b33697ad63ffbe3eadafb&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Volumes&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;WorkingDir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/app&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Entrypoint&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;java&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;-jar&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;app.jar&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;OnBuild&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Labels&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;testImage&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;container&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6dc97c1a3b1f527df5fd18460ce766e1960a0d7a4f07a013b884e74d4a5c79be&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;container_config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Hostname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6dc97c1a3b1f&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Domainname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;User&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AttachStdin&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AttachStdout&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AttachStderr&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ExposedPorts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;8080/tcp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Tty&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;OpenStdin&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;StdinOnce&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Env&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/lib/jvm/java-1.8-openjdk/jre/bin:/usr/lib/jvm/java-1.8-openjdk/bin&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;LANG=C.UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;JAVA_HOME=/usr/lib/jvm/java-1.8-openjdk&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;JAVA_VERSION=8u212&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;JAVA_ALPINE_VERSION=8.212.04-r0&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Cmd&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;/bin/sh&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;-c&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;#(nop) &quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;ENTRYPOINT [\&quot;java\&quot; \&quot;-jar\&quot; \&quot;app.jar\&quot;]&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:2b6a6388a9a8cc96d4b34abcf222b981a9abd86e999b33697ad63ffbe3eadafb&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Volumes&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;WorkingDir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/app&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Entrypoint&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;java&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;-jar&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;app.jar&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;OnBuild&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Labels&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;testImage&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-02-14T09:01:30.341153211Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;docker_version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;20.10.7&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;history&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2019-05-11T00:07:03.358250803Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/bin/sh -c #(nop) ADD file:a86aea1f3a7d68f6ae03397b99ea77f2e9ee901c5c59e59f76f93adbb4035913 in / &quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2019-05-11T00:07:03.510395965Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/bin/sh -c #(nop)  CMD [\&quot;/bin/sh\&quot;]&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;empty_layer&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2019-05-11T01:32:11.0323736Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/bin/sh -c #(nop)  ENV LANG=C.UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;empty_layer&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2019-05-11T01:32:12.044405061Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/bin/sh -c &#123; \t\techo &#x27;#!/bin/sh&#x27;; \t\techo &#x27;set -e&#x27;; \t\techo; \t\techo &#x27;dirname \&quot;$(dirname \&quot;$(readlink -f \&quot;$(which javac || which java)\&quot;)\&quot;)\&quot;&#x27;; \t&#125; &gt; /usr/local/bin/docker-java-home \t&amp;&amp; chmod +x /usr/local/bin/docker-java-home&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2019-05-11T01:32:12.271831312Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/bin/sh -c #(nop)  ENV JAVA_HOME=/usr/lib/jvm/java-1.8-openjdk&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;empty_layer&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2019-05-11T01:32:12.506789049Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/bin/sh -c #(nop)  ENV PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/lib/jvm/java-1.8-openjdk/jre/bin:/usr/lib/jvm/java-1.8-openjdk/bin&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;empty_layer&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2019-05-11T01:32:12.755877628Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/bin/sh -c #(nop)  ENV JAVA_VERSION=8u212&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;empty_layer&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2019-05-11T01:32:13.051281176Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/bin/sh -c #(nop)  ENV JAVA_ALPINE_VERSION=8.212.04-r0&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;empty_layer&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2019-05-11T01:32:17.777332452Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/bin/sh -c set -x \t&amp;&amp; apk add --no-cache \t\topenjdk8=\&quot;$JAVA_ALPINE_VERSION\&quot; \t&amp;&amp; [ \&quot;$JAVA_HOME\&quot; = \&quot;$(docker-java-home)\&quot; ]&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-02-14T08:58:24.52137399Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\&quot;skywater\&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/bin/sh -c #(nop)  MAINTAINER \&quot;skywater\&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;empty_layer&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-02-14T08:58:24.635972282Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\&quot;skywater\&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/bin/sh -c #(nop)  LABEL description=testImage&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;empty_layer&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-02-14T08:58:25.287249679Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\&quot;skywater\&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/bin/sh -c mkdir /tmp/logs&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-02-14T08:58:25.411811261Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\&quot;skywater\&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/bin/sh -c #(nop) WORKDIR /app&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-02-14T09:01:30.110467033Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\&quot;skywater\&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/bin/sh -c #(nop) COPY file:6b7274fe9bd12de07992236f81d0b51d17356a0cc3df9a153584843d4f73c3cf in /app/app.jar &quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-02-14T09:01:30.226144552Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\&quot;skywater\&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/bin/sh -c #(nop)  EXPOSE 8080&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;empty_layer&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-02-14T09:01:30.341153211Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\&quot;skywater\&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/bin/sh -c #(nop)  ENTRYPOINT [\&quot;java\&quot; \&quot;-jar\&quot; \&quot;app.jar\&quot;]&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;empty_layer&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;rootfs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;layers&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;diff_ids&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;sha256:f1b5933fe4b5f49bbe8258745cf396afe07e625bdab3168e364daf7c956b6b81&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;sha256:9b9b7f3d56a01e3d9076874990c62e7a516cc4032f784f421574d06b18ef9aa4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;sha256:ceaf9e1ebef5f9eaa707a838848a3c13800fcf32d7757be10d4b08fb85f1bc8a&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;sha256:611c936fd113e79ca783c390c3abe2877ed041f70b9cf034749a269692b5acdc&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;sha256:265cbbb1847e96bd58716d5faebea214c613098ddca73253dd2d7229ddf80865&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;sha256:50522ab76e98bd51cedd8d7442cb7b74c7e455f6e6d6efc2158a78f3185ca5e8&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>可以发现其与OCI中的Image Configuration定义基本一致。</p>
<p>关注其中几个属性：</p>
<ul>
<li><p><strong>config</strong></p>
<p>参照我们最开始的Dockerfile，config里面对应了容器暴露的端口、Endpoint配置。</p>
</li>
<li><p><strong>history</strong></p>
<p><strong>empty_layer</strong>如果为true，则代表只是修改了配置信息，而未变动文件内容，所以并不需要生成新的layer以及对应hash，只要在这里记录配置操作即可。</p>
<p>首先，Dockerfile中定义了<code>From openjdk:8-jdk-alpine</code>，所以会有相关jdk1.8的一些指令。</p>
<p>我们每定义一次RUN、COPY等引起layer内容发生变化的操作时，就会生成新的layer，empty_layer属性也将会是默认的false。</p>
<p>从这里可以看出，Dockerfile指令与Docker Image内容形成了完整的联系。</p>
</li>
<li><p><strong>rootfs.diff_ids</strong></p>
<p>如果仔细观察diff_ids中的hash，发现无论是image manifest中的layers，还是说本地解压镜像文件的blobs中，都从未出现过这些ID。</p>
<p>其实，这些ID是layer归档文件的ID，而非layer压缩归档的ID。我们只要计算下layer.tar的hash值，就可以和这里对应上了。</p>
<p>譬如diff_ids[0] &#x3D; “sha256:f1b5933fe4b5f49bbe8258745cf396afe07e625bdab3168e364daf7c956b6b81”</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@skywater springboot-demo]# sha256sum 1a58e6937db044ef6f2e2962a0dc7bef16a6c33fdfc5a0318c39092612a1bd1a/layer.tar</span><br><span class="line">f1b5933fe4b5f49bbe8258745cf396afe07e625bdab3168e364daf7c956b6b81  1a58e6937db044ef6f2e2962a0dc7bef16a6c33fdfc5a0318c39092612a1bd1a/layer.tar</span><br></pre></td></tr></table></figure>

<p>可以看到该layer.tar的hash值就是<code>f1b5933...</code></p>
<p>实际在docker本地环境中的存储位置为<code>/var/lib/docker/image/overlay2/layerdb/sha256/f1b5933fe4b5f49bbe8258745cf396afe07e625bdab3168e364daf7c956b6b81</code></p>
<p><strong>镜像是由layer构成的，layer文件以hash摘要寻址存放，所以，不同的image可以复用相同的layer。</strong></p>
</li>
</ul>
<h4 id="Filesystem-Layer"><a href="#Filesystem-Layer" class="headerlink" title="Filesystem Layer"></a>Filesystem Layer</h4><p>Image Manefest中除了Config信息，还有一块内容就是对Layers的描述。</p>
<p>OCI对Layer的mediaType定义与Docker中略有不同。</p>
<table>
<thead>
<tr>
<th>OCI</th>
<th>Docker</th>
</tr>
</thead>
<tbody><tr>
<td><code>application/vnd.oci.image.layer.v1.tar</code><br/><code>application/vnd.oci.image.layer.v1.tar+gzip</code><br/><code>application/vnd.oci.image.layer.v1.tar+zstd</code><br/><code>application/vnd.oci.image.layer.nondistributable.v1.tar</code><br/><code>application/vnd.oci.image.layer.nondistributable.v1.tar+gzip</code><br/><code>application/vnd.oci.image.layer.nondistributable.v1.tar+zstd</code></td>
<td><code>application/vnd.docker.image.rootfs.diff.tar.gzip</code></td>
</tr>
</tbody></table>
<p>可以通过解压layer.tar查看每一层的具体内容。</p>
<p>Docker容器实质上就是层与层的叠加，上方层可以通过覆盖的方式实现对下方层内容的增删改。最上方的层为读写层，会在从镜像转变为容器时生成，用于与宿主机频繁交互。其余下方的层只有只读权限，无法进行修改。</p>
<p>最后，需要有一个联合挂载系统（Docker一般使用overlay），将各个层联合起来，是指成为一个整体，用户视图将只存在一个。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Docker作为OCI最初的贡献者，随着时间演化，其具体实现与OCI标准略有不同，但互相兼容。均通过manifest list来查找合适的镜像文件，并采用分层结构，使用manifest来定义层的顺序与位置，并指向层配置文件。通过读取层配置文件，就可以获取到所有具体的层配置信息了。从而构建了完整的镜像内容架构，提供给具体镜像实现工具一个统一的流程规范。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/OCI/" rel="tag"># OCI</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/Java%E5%B9%B6%E5%8F%91-CPU%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="prev" title="Java并发-CPU如何实现的多线程">
                  <i class="fa fa-chevron-left"></i> Java并发-CPU如何实现的多线程
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/Buildah%E5%85%A5%E9%97%A8/" rel="next" title="Buildah入门">
                  Buildah入门 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">你丶一顾倾城</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
